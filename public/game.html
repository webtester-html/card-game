<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2e7d32;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: auto;
        }
        .game-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            pointer-events: none;
        }
        .player-area {
            width: 100%;
            text-align: center;
            position: absolute;
            bottom: 20px;
            z-index: 100;
            pointer-events: auto;
        }
        .opponents-container {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            position: absolute;
            top: 20px;
            gap: 20px;
            z-index: 20;
            pointer-events: none;
        }
        .opponent-area {
            text-align: center;
            flex: 1;
            min-width: 150px;
            max-width: 250px;
            pointer-events: none;
        }
        .opponent-area .hand {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            justify-items: center;
        }
        .player-area h2,
        .opponent-area h2 {
            margin: 10px 0;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            font-size: 1.2em;
        }
        .player-area .highlight,
        .opponent-area .highlight {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 5px;
            border-radius: 4px;
        }
        .debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 4px;
            z-index: 200;
            pointer-events: none;
        }
        .deck-area {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            pointer-events: none;
        }
        .deck {
            position: relative;
        }
        .trump-card {
            margin-top: 15px;
            transform: rotate(-90deg);
        }
        .trump-card .card {
            width: 120px;
            height: 168px;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        .deck-count {
            color: white;
            font-size: 14px;
            margin-top: 10px;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        }
        .table-area {
            flex-grow: 1;
            width: 100%;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            justify-items: center;
            align-content: center;
            padding: 20px;
            margin-left: 150px;
            box-sizing: border-box;
            position: relative;
            z-index: 25;
            pointer-events: none;
        }
        .card-pair {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .hand {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            pointer-events: auto;
        }
        .opponent-area .hand {
            pointer-events: none;
        }
        .opponent-area .hand .card {
            transform: scale(0.7);
        }
        .card {
            width: 100px;
            height: 140px;
            background: white;
            border: 1px solid #000;
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            box-sizing: border-box;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, border 0.2s;
            color: red;
            pointer-events: auto;
            z-index: 101;
        }
        .card.clickable {
            border: 2px solid green;
        }
        .card:hover:not(.disabled) {
            transform: translateY(-5px);
        }
        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border: 1px solid #000;
        }
        .card.pending {
            opacity: 0.7;
            border: 2px dashed #ffd700;
            transform: scale(1.05);
        }
        .card-back {
            background: repeating-linear-gradient(45deg, #b71c1c, #b71c1c 10px, #d32f2f 10px, #d32f2f 20px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }
        .card .rank {
            font-size: 18px;
            font-weight: bold;
        }
        .card .suit {
            font-size: 24px;
        }
        .card .top-left,
        .card .bottom-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .card .bottom-right {
            transform: rotate(180deg);
        }
        .defense-card {
            margin-top: -100px;
            margin-left: 60px;
            transform: rotate(10deg);
        }
        #endTurnBtn,
        #takeCardsBtn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #0288d1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            display: none;
            pointer-events: auto;
        }
        #endTurnBtn:hover:not(:disabled),
        #takeCardsBtn:hover:not(:disabled) {
            background-color: #0277bd;
        }
        #endTurnBtn:disabled,
        #takeCardsBtn:disabled {
            background-color: #b0bec5;
            cursor: not-allowed;
        }
        #errorMessage {
            color: #ff5252;
            margin: 10px 0;
            text-align: center;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        }
        @media (max-width: 768px) {
            .table-area {
                grid-template-columns: repeat(4, 1fr);
                margin-left: 120px;
            }
            .opponent-area .hand {
                grid-template-columns: repeat(4, 1fr);
            }
            .card {
                width: 80px;
                height: 112px;
                padding: 6px;
            }
            .trump-card .card {
                width: 96px;
                height: 134.4px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="debug-info" id="debugInfo"></div>
        <div class="opponents-container" id="opponentsContainer"></div>
        <div class="table-area" id="table"></div>
        <div class="deck-area">
            <div class="deck" id="deck"></div>
            <div class="trump-card" id="trumpCard"></div>
            <div class="deck-count" id="deckCount"></div>
        </div>
        <div class="player-area">
            <h2 id="playerName"></h2>
            <div class="hand" id="playerHand"></div>
            <button id="endTurnBtn">End Turn</button>
            <button id="takeCardsBtn">Take Cards</button>
            <div id="errorMessage"></div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('game.html: Script started');
            const socket = io();
            const playerNameEl = document.getElementById('playerName');
            const opponentsContainer = document.getElementById('opponentsContainer');
            const playerHandEl = document.getElementById('playerHand');
            const tableEl = document.getElementById('table');
            const deckEl = document.getElementById('deck');
            const trumpCardEl = document.getElementById('trumpCard');
            const deckCountEl = document.getElementById('deckCount');
            const endTurnBtn = document.getElementById('endTurnBtn');
            const takeCardsBtn = document.getElementById('takeCardsBtn');
            const errorMessageEl = document.getElementById('errorMessage');
            const debugInfoEl = document.getElementById('debugInfo');
            let roomId = '';
            let playerId = '';
            let playerName = '';
            let pendingAttackCard = null;
            let pendingDefenseCard = null;
            let isTakingCards = false;

            // Initialize from localStorage
            roomId = localStorage.getItem('roomId') || new URLSearchParams(window.location.search).get('room') || '';
            playerId = localStorage.getItem('playerId') || '';
            playerName = localStorage.getItem('playerName') || '';

            console.log('game.html: Initial data:', { roomId, playerId, playerName });

            if (!roomId || !playerId || !playerName) {
                console.error('game.html: Missing roomId, playerId, or playerName');
                errorMessageEl.textContent = 'Missing room or player information';
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            const suitSymbols = {
                Hearts: '♥',
                Diamonds: '♦',
                Clubs: '♣',
                Spades: '♠'
            };

            const rankDisplay = {
                '6': '6', '7': '7', '8': '8', '9': '9', '10': '10',
                'Jack': 'J', 'Queen': 'Q', 'King': 'K', 'Ace': 'A'
            };

            const rankOrder = ['6', '7', '8', '9', '10', 'Jack', 'Queen', 'King', 'Ace'];

            function isValidCard(card) {
                return card && card.rank && card.suit &&
                       rankOrder.includes(card.rank) && Object.keys(suitSymbols).includes(card.suit);
            }

            function renderCard(card, clickable = false, role = null, isPending = false) {
                if (!isValidCard(card)) {
                    console.warn('game.html: Invalid card:', card);
                    return '';
                }
                const suitClass = card.suit.toLowerCase();
                const isDisabled = clickable ? '' : 'disabled';
                const pendingClass = isPending ? 'pending' : '';
                const clickableClass = clickable ? 'clickable' : '';
                const displayRank = rankDisplay[card.rank] || card.rank;
                return `
                    <div class="card ${suitClass} ${isDisabled} ${pendingClass} ${clickableClass}"
                         data-rank="${card.rank}" data-suit="${card.suit}" ${role ? `data-role="${role}"` : ''}>
                        <div class="top-left">
                            <div class="rank">${displayRank}</div>
                            <div class="suit">${suitSymbols[card.suit]}</div>
                        </div>
                        <div class="bottom-right">
                            <div class="rank">${displayRank}</div>
                            <div class="suit">${suitSymbols[card.suit]}</div>
                        </div>
                    </div>
                `;
            }

            function renderCardBack() {
                return `<div class="card card-back"></div>`;
            }

            function renderDeck(count) {
                if (!Number.isInteger(count) || count < 0) return '';
                let cards = '';
                for (let i = 0; i < Math.min(count, 3); i++) {
                    const offset = i * 2;
                    cards += `<div class="card card-back" style="position: absolute; top: ${offset}px; left: ${offset}px;"></div>`;
                }
                return cards;
            }

            function isValidAttackCard(card, table) {
                if (!isValidCard(card)) return false;
                if (!table || table.length === 0) return true;
                return table.some(pair => pair.attack && pair.attack.rank === card.rank);
            }

            function isValidDefenseCard(card, table, trumpSuit) {
                if (!isValidCard(card) || !table || table.length === 0) return false;
                const lastAttack = table.find(pair => pair.attack && !pair.defense);
                if (!lastAttack || !isValidCard(lastAttack.attack)) return false;
                return (card.suit === lastAttack.attack.suit &&
                        rankOrder.indexOf(card.rank) > rankOrder.indexOf(lastAttack.attack.rank)) ||
                       (trumpSuit && card.suit === trumpSuit);
            }

            function updateDebugInfo(state) {
                const clickableCards = playerHandEl.querySelectorAll('.card.clickable').length;
                const handRect = playerHandEl.getBoundingClientRect();
                debugInfoEl.textContent = `Room: ${roomId}, Player: ${playerName}, ID: ${playerId || 'N/A'}, Attacker: ${state?.currentAttacker || 'N/A'}, Defender: ${state?.currentDefender || 'N/A'}, Clickable Cards: ${clickableCards}, Hand: (${handRect.left}, ${handRect.top}, ${handRect.width}x${handRect.height})`;
            }

            function showError(msg) {
                errorMessageEl.textContent = msg;
                setTimeout(() => errorMessageEl.textContent = '', 3000);
            }

            function handleCardClick(cardEl, e) {
                if (cardEl.classList.contains('disabled')) {
                    showError('Not your turn');
                    return;
                }
                const rank = cardEl.dataset.rank;
                const suit = cardEl.dataset.suit;
                const role = cardEl.dataset.role;
                if (!rank || !suit || !role) {
                    showError('Invalid card');
                    return;
                }
                if (role === 'attack') {
                    pendingAttackCard = { rank, suit };
                } else if (role === 'defend') {
                    pendingDefenseCard = { rank, suit };
                }
                socket.emit('playCard', { roomId, playerName, playerId, card: { rank, suit }, role });
            }

            function updateGameUI(data) {
                if (!data || !data.players || data.players.length < 2) {
                    console.error('game.html: Invalid game data:', data);
                    showError('Invalid game data');
                    return;
                }

                const player = data.players.find(p => p.id === playerId);
                const opponent = data.players.find(p => p.id !== playerId && !p.isDisconnected);
                const currentAttacker = data.currentAttacker;
                const currentDefender = data.currentDefender;
                const table = data.table || [];
                const deckCount = data.deckCount || 0;
                const trump = data.trump;

                if (!player) {
                    showError('Player not found');
                    setTimeout(() => window.location.href = '/', 2000);
                    return;
                }

                playerNameEl.textContent = `${player.name} (${player.id === currentAttacker ? 'Attacker' : player.id === currentDefender ? 'Defender' : 'Player'})`;
                playerNameEl.classList.toggle('highlight', player.id === currentAttacker || player.id === currentDefender);

                const playerHand = Array.isArray(player.hand) ? player.hand.filter(isValidCard) : [];
                playerHandEl.innerHTML = playerHand.map(card => {
                    const isAttacker = player.id === currentAttacker;
                    const isDefender = player.id === currentDefender;
                    const isValidMove = isAttacker ? isValidAttackCard(card, table) : isDefender ? isValidDefenseCard(card, table, trump?.suit) : false;
                    const clickable = isValidMove && !isTakingCards && !player.isDisconnected;
                    const isPending = (isAttacker && pendingAttackCard && pendingAttackCard.rank === card.rank && pendingAttackCard.suit === card.suit) ||
                                     (isDefender && pendingDefenseCard && pendingDefenseCard.rank === card.rank && pendingDefenseCard.suit === card.suit);
                    return renderCard(card, clickable, isAttacker ? 'attack' : isDefender ? 'defend' : null, isPending);
                }).join('');

                const cardEls = playerHandEl.querySelectorAll('.card');
                cardEls.forEach(cardEl => {
                    cardEl.removeEventListener('click', cardEl._clickHandler);
                    cardEl.removeEventListener('touchstart', cardEl._touchHandler);
                    const handler = (e) => handleCardClick(cardEl, e);
                    cardEl._clickHandler = handler;
                    cardEl._touchHandler = handler;
                    cardEl.addEventListener('click', handler);
                    cardEl.addEventListener('touchstart', handler, { passive: true });
                });

                opponentsContainer.innerHTML = opponent ? `
                    <div class="opponent-area">
                        <h2 class="${opponent.id === currentAttacker || opponent.id === currentDefender ? 'highlight' : ''}">
                            ${opponent.name} (${opponent.id === currentAttacker ? 'Attacker' : opponent.id === currentDefender ? 'Defender' : 'Player'})
                        </h2>
                        <div class="hand">
                            ${opponent.hand && opponent.hand.length > 0 ? opponent.hand.map(() => renderCardBack()).join('') : renderCardBack()}
                        </div>
                    </div>
                ` : '';

                tableEl.innerHTML = table.map((pair, index) => {
                    if (!pair.attack || !isValidCard(pair.attack)) return '';
                    let defenseCardHtml = pair.defense && isValidCard(pair.defense) ? renderCard(pair.defense, false, 'defense-card') : '';
                    if (pendingDefenseCard && index === table.length - 1 && !pair.defense) {
                        defenseCardHtml = renderCard(pendingDefenseCard, false, 'defense-card', true);
                    }
                    const isPendingAttack = pendingAttackCard && pendingAttackCard.rank === pair.attack.rank && pendingAttackCard.suit === pair.attack.suit;
                    return `
                        <div class="card-pair">
                            ${renderCard(pair.attack, false, null, isPendingAttack)}
                            ${defenseCardHtml}
                        </div>
                    `;
                }).join('');

                deckEl.innerHTML = renderDeck(deckCount);
                deckCountEl.textContent = `Deck: ${deckCount}`;
                trumpCardEl.innerHTML = trump && isValidCard(trump.card) ? renderCard(trump.card, false) : '';

                updateDebugInfo(data);
            }

            socket.on('connect', () => {
                console.log('game.html: Socket connected:', socket.id);
                socket.emit('joinRoom', { roomId, playerName, playerId });
                socket.emit('reconnectPlayer', { roomId, playerId, playerName });
            });

            socket.on('roomJoined', ({ roomId: joinedRoomId, playerId: newPlayerId, playerName: joinedPlayerName }) => {
                roomId = joinedRoomId;
                playerId = newPlayerId;
                playerName = joinedPlayerName;
                localStorage.setItem('roomId', roomId);
                localStorage.setItem('playerId', playerId);
                localStorage.setItem('playerName', playerName);
                console.log('game.html: Room joined:', { roomId, playerId, playerName });
            });

            socket.on('updateGame', (data) => {
                console.log('game.html: Received updateGame:', data);
                window.lastGameState = data;
                pendingAttackCard = null;
                pendingDefenseCard = null;
                isTakingCards = false;
                updateGameUI(data);
            });

            socket.on('buttonState', ({ showEndTurn, showTakeCards, isDefender }) => {
                endTurnBtn.style.display = isDefender && showEndTurn ? 'inline-block' : 'none';
                takeCardsBtn.style.display = isDefender && showTakeCards ? 'inline-block' : 'none';
                takeCardsBtn.disabled = isTakingCards;
            });

            socket.on('errorMessage', (msg) => {
                console.log('game.html: Error:', msg);
                showError(msg);
                pendingAttackCard = null;
                pendingDefenseCard = null;
                isTakingCards = false;
                updateGameUI(window.lastGameState || {});
            });

            socket.on('gameOver', ({ winners }) => {
                showError(`Game Over! Winner: ${winners.join(', ')}`);
                setTimeout(() => window.location.href = '/', 5000);
            });

            socket.on('playerReconnected', ({ playerName }) => {
                showError(`${playerName} reconnected`);
            });

            socket.on('roomDeleted', (msg) => {
                showError(msg);
                setTimeout(() => window.location.href = '/', 3000);
            });

            endTurnBtn.addEventListener('click', () => {
                console.log('game.html: Ending turn:', { playerId, playerName });
                socket.emit('endTurn', { roomId, playerId, playerName });
            });

            takeCardsBtn.addEventListener('click', () => {
                if (isTakingCards) return;
                console.log('game.html: Taking cards:', { playerId, playerName });
                isTakingCards = true;
                takeCardsBtn.disabled = true;
                socket.emit('takeCards', { roomId, playerId, playerName });
                setTimeout(() => {
                    isTakingCards = false;
                    takeCardsBtn.disabled = false;
                }, 2000);
            });

            window.addEventListener('beforeunload', () => {
                socket.emit('tempDisconnect', { roomId, playerId, playerName });
            });

            // Initial join
            socket.emit('joinRoom', { roomId, playerName, playerId });
            socket.emit('reconnectPlayer', { roomId, playerId, playerName });
        });
    </script>
</body>
</html>
